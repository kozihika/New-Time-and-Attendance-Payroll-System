<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <title>塾長専用ダッシュボード</title>
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
  </head>
  <body>
    <script>
      const appUrl = '<?= getAppUrl() ?>';
      const masterData = <?!= JSON.stringify(masterData) ?>;
    </script>

    <h1>塾長専用ダッシュボード</h1>

    <label for="instructor-selector">講師:</label>
    <select id="instructor-selector"></select>

    <label for="month-selector">月:</label>
    <input type="month" id="month-selector">

    <button id="view-button">表示</button>

    <h2>今月の総支給額: <span id="monthly-total">---</span></h2>
    <h2>今年の累計支給額: <span id="yearly-total">---</span></h2>

    <h2>給与明細</h2>
    <table border="1" cellpadding="5" cellspacing="0">
      <tr><th colspan="2">支給</th></tr>
      <tr><td>コマ給</td><td id="koma-pay"></td></tr>
      <tr><td>事務作業給</td><td id="task-pay"></td></tr>
      <tr><td>交通費</td><td id="transport-pay"></td></tr>
      <tr><td><b>支給合計</b></td><td id="gross-pay"></td></tr>

      <tr><th colspan="2">控除</th></tr>
      <tr><td>所得税</td><td><input type="number" id="incomeTaxInput" value="0" class="deduction-input"></td></tr>
      <tr><td>住民税</td><td><input type="number" id="residentTaxInput" value="0" class="deduction-input"></td></tr>
      <tr><td>健康保険</td><td><input type="number" id="healthInsuranceInput" value="0" class="deduction-input"></td></tr>
      <tr><td>厚生年金</td><td><input type="number" id="pensionInput" value="0" class="deduction-input"></td></tr>
      <tr><td>雇用保険</td><td><input type="number" id="employmentInsuranceInput" value="0" class="deduction-input"></td></tr>
      <tr><td><b>控除合計</b></td><td id="deduction-total">0円</td></tr>

      <tr><th colspan="2">差引支給額</th></tr>
      <tr><td colspan="2" id="net-pay"></td></tr>
    </table>

    <br>
    <button id="finalize-button">全ての講師の給与を締める</button>
    <button id="pdf-button">PDF出力</button>
    <button id="logout-btn">ログアウト</button>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const instructorSelect = document.getElementById('instructor-selector');
        const monthSelect = document.getElementById('month-selector');
        const viewButton = document.getElementById('view-button');

        // --- 講師プルダウン生成 ---
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "-- 講師を選択 --";
        instructorSelect.appendChild(defaultOption);
        masterData.instructors.forEach(function(instructor) {
          if (instructor.role === '講師') {
            const option = document.createElement('option');
            option.value = instructor.id;
            option.textContent = instructor.name;
            instructorSelect.appendChild(option);
          }
        });

        // 給与表示ボタン処理
        viewButton.addEventListener('click', function() {
          const targetInstructorId = instructorSelect.value;
          const targetYearMonth = monthSelect.value;

          if (!targetInstructorId || !targetYearMonth) {
            alert('講師と対象月を両方選択してください。');
            return;
          }

          google.script.run
            .withSuccessHandler(function(salaryData) {
              if (salaryData.error) {
                alert(salaryData.error);
                return;
              }
              const monthly = salaryData.monthly;
              const yearly = salaryData.yearly;

              // 講師の給料表示を更新する関数
              function updateDisplay() {
                // 支給
                document.getElementById('monthly-total').textContent = monthly.total + "円";
                document.getElementById('yearly-total').textContent = yearly.total + "円";
                document.getElementById('koma-pay').textContent = monthly.komaSalary + "円";
                document.getElementById('task-pay').textContent = monthly.taskSalary + "円";
                document.getElementById('transport-pay').textContent = monthly.transportationFee + "円";
                document.getElementById('gross-pay').textContent = monthly.total + "円";

                // 控除合計計算
                let totalDeduction = 0;
                document.querySelectorAll('.deduction-input').forEach(input => {
                  totalDeduction += Number(input.value) || 0;
                });

                // 手取り計算
                const net = monthly.total - totalDeduction;
                document.getElementById('deduction-total').textContent = totalDeduction + "円";
                document.getElementById('net-pay').textContent = net + "円";
              }

              // 初期表示
              updateDisplay();

              // 入力変更イベント
              document.querySelectorAll('.deduction-input').forEach(input => {
                input.oninput = updateDisplay;
              });
            })
            .getSalaryDataForManagement(targetInstructorId, targetYearMonth);
        });

        // ログアウト
        document.getElementById('logout-btn').addEventListener('click', function() {
          google.script.run.withSuccessHandler(function() {
            window.top.location.href = appUrl;
          }).logout();
        });

        // PDF出力
        document.getElementById('pdf-button').addEventListener('click', function() {
          const teacher = instructorSelect.value;
          const month = monthSelect.value;

          // 各控除をまとめる
          const deductions = {
            incomeTax: Number(document.getElementById('incomeTaxInput').value) || 0,
            residentTax: Number(document.getElementById('residentTaxInput').value) || 0,
            healthInsurance: Number(document.getElementById('healthInsuranceInput').value) || 0,
            pension: Number(document.getElementById('pensionInput').value) || 0,
            employmentInsurance: Number(document.getElementById('employmentInsuranceInput').value) || 0,
          };

          if (!teacher || !month) {
            alert('講師と対象月を選択してください。');
            return;
          }

          google.script.run.withSuccessHandler(function(url) {
            window.open(url, "_blank");
          }).generatePayslipPdf(teacher, month, deductions);
        });

        // 締め処理
        document.getElementById('finalize-button').addEventListener('click', function() {
          const month = monthSelect.value;
          if (!month) {
            alert('対象月を選択してください。');
            return;
          }
          if (confirm(month + 'の給与を締め切ります。よろしいですか？')) {
            google.script.run.withSuccessHandler(function(msg) {
              alert(msg);
            }).closeMonth(month);
          }
        });
      });
    </script>
  </body>
</html>

