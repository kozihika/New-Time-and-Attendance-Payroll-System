<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <body>
    <header>
      <section class="welcome-message">
        <h2 class="user-greeting">
        <?
          const currentUser = masterData.instructors.find((instructor)=>
            instructor.id == loggedInUser) ;
          if(currentUser){
        ?>
        <?= currentUser.name ?>ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼
        <?
          }
        ?>
        </h2>

        <div class="monthly-fortune-section">
          <p>
            ä»Šæœˆã®å¹³å‡é‹å‹¢ï¼ˆ<?= averageFortune ?>ãƒã‚¤ãƒ³ãƒˆï¼‰:
            <span id="average-fortune"><?= averageFortuneText ?></span>
          </p>
          <small>ï¼ˆå¹³å‡é‹å‹¢:0æœªæº€â†’å‡¶ã€0ä»¥ä¸Š1æœªæº€â†’å‰ã€1ä»¥ä¸Šâ†’å¤§å‰ï¼‰</small>
        </div>
      </section>
   </header>


    <main>
      <section class="action-buttons">
        <button id="clock-in-btn" disabled>å‡ºå‹¤</button>
        <button id="clock-out-btn"  disabled>é€€å‹¤</button>
        <button id="task-start-btn" disabled>äº‹å‹™ä½œæ¥­é–‹å§‹</button>
        <button id="task-end-btn" disabled>äº‹å‹™ä½œæ¥­çµ‚äº†</button>
        <button id="start-break-btn" disabled>ä¼‘æ†©é–‹å§‹</button>
        <button id="end-break-btn" disabled>ä¼‘æ†©çµ‚äº†</button>
      </section>
      <section class="transportation-fee-form">
        <label>äº¤é€šè²»ä¿®æ­£</label>
        <input type="number" id="transportation-fee" placeholder="ä¿®æ­£é¡ï¼ˆå††ä¸è¦ï¼‰">
        <button id="update-transportation-fee-btn" disabled>äº¤é€šè²»ã‚’ä¿®æ­£</button>
      </section>
      

      <button id="logout-btn" disabled>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

      <div id="check-out-modal">
        <div class="modal-content">
          <h3>æœ¬æ—¥ã®æ‹…å½“æˆæ¥­ã‚’å ±å‘Šã—ã¦ãã ã•ã„</h3>
          <div>
            <label for="period-selector">æœŸé–“ç¨®åˆ¥:</label>
            <select id="period-selector">
              <option value="é€šå¸¸">é€šå¸¸</option>
              <option value="å­£ç¯€è¬›ç¿’">å­£ç¯€è¬›ç¿’</option>
            </select>
          </div>
          <div id='task-checklist'></div>
          <button id="submit-checkout-btn">ç™»éŒ²å®Œäº†</button>
        </div>
        <div id="fortune-container" style="display: none;">
          <div id="fortune-result">
            <p id="fortune-text"></p>
            <p id="fortune-message"></p>
            <p id="fortune-points"></p>
          </div>
        </div>
      </div>

    </main>

 

    <footer></footer>
    <script>
      const appUrl = '<?= getAppUrl() ?>';
      const loggedInUser = <?= loggedInUser ?>;
      const masterData = <?!= JSON.stringify(masterData) ?>;
      let currentStatus = "not-clocked-in";

      //ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ã€ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¤‰æ›´
      document.addEventListener("DOMContentLoaded", ()=>{
        updateButtonStates(currentStatus)
      })

    // å‡ºå‹¤ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
      document.getElementById('clock-in-btn').addEventListener('click', function() {

    // GASå´ã®`recordClockIn`é–¢æ•°ã‚’å‘¼ã³å‡ºã™
        google.script.run
          .withSuccessHandler(function(response) {
            alert(response); // æˆåŠŸã—ãŸã‚‰GASã‹ã‚‰ã®è¿”äº‹ã‚’è¡¨ç¤º
            currentStatus = 'working'; // çŠ¶æ…‹ã‚’ã€Œå‹¤å‹™ä¸­ã€ã«æ›´æ–°
            updateButtonStates(currentStatus); // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          })
          .recordClockIn(loggedInUser);
      });

      document.getElementById('clock-out-btn').addEventListener('click', function() {

          // 1. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ä½¿ã†HTMLè¦ç´ ã‚’å–å¾—
          const periodSelector = document.getElementById('period-selector');
          const checklistContainer = document.getElementById('task-checklist');
          const classLevels = masterData.classLevels;

          // 2. æ™‚é–“å‰²ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®é–¢æ•°ã‚’å®šç¾©
          function updateScheduleList() {
            const selectedPeriod = periodSelector.value;
            // masterData.scheduleã®ä¸­ã‹ã‚‰ã€é¸æŠã•ã‚ŒãŸæœŸé–“ã®æˆæ¥­ãƒªã‚¹ãƒˆã‚’å–å¾—
            const schedule = masterData.schedule[selectedPeriod] || [];
            
            let tasksHtml = '';
            
            // æˆæ¥­ãƒ¬ãƒ™ãƒ«ã®é¸æŠè‚¢ã‚’æº–å‚™
            let levelOptions = '<option value="">-- å­¦å¹´ã‚’é¸æŠ --</option>';
            classLevels.forEach((level) => {
              levelOptions += `<option value="${level.level}">${level.level}</option>`;
            });

            // å–å¾—ã—ãŸæˆæ¥­ãƒªã‚¹ãƒˆã§ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
            schedule.forEach((classItem) => {
              tasksHtml += `
                <div class="task-item" data-task-name="${classItem.name}">
                    <label>${classItem.name} (${classItem.startTime}-${classItem.endTime})</label>
                    <select class="level-select">
                        ${levelOptions}
                    </select>
                </div>
                <hr>
              `;
            });
            checklistContainer.innerHTML = tasksHtml;
          }

          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã‹ã‚ŒãŸæ™‚ã«ã€æœ€åˆã®æ™‚é–“å‰²ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹
          updateScheduleList(); 

          // æœŸé–“ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€æ™‚é–“å‰²ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹
          periodSelector.addEventListener('change', updateScheduleList);
          

          // æœ€å¾Œã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹
          document.getElementById('check-out-modal').style.display = 'block';
        });
    /**
     * ã€Œç™»éŒ²å®Œäº†ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€æ‰“åˆ»å±¥æ­´ã«æ‹…å½“æˆæ¥­ã¨æ™‚åˆ»ã‚’æ‰“åˆ»ã€ãŠã¿ãã˜ã‚’å¼•ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹
     */
      document.getElementById('submit-checkout-btn').addEventListener('click', function() {
        //æ„å›³ã—ã¦ã„ãªã„å¤‰æ›´ã‚’é˜²ããŸã‚ã«querySelectorã§çµ±ä¸€
        //task-itemã¯htmlã®æˆæ¥­é¸æŠæ¬„
        //task-checklistã¯task-itemã‚’å¤–åŒ…ã™ã‚‹ç®±
        const checklistContainer = document.querySelector('#task-checklist');
        const classRows = checklistContainer.querySelectorAll('.task-item');
        const selectedPeriod = document.getElementById("period-selector").value;  
        const taughtClasses = [];
        
        // å„æ™‚é™ã”ã¨ã®æˆæ¥­ãƒ¬ãƒ™ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
        classRows.forEach(row => {
          // data-task-nameã‹ã‚‰æˆæ¥­åã‚’å–å¾—ï¼ˆdatasetã§data-task-nameã§æˆæ¥­æ™‚é™ã‚’å®šç¾©ã—ã¦ã„ã‚‹ï¼‰ã€€næ™‚é™ç›®ã®å‡¦ç†
          const className = row.dataset.taskName;
          // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§é¸æŠã•ã‚ŒãŸå­¦å¹´ã‚’å–å¾—ã€€optionã®valueã‚’å–ã‚Šå‡ºã™
          const selectedLevel = row.querySelector('.level-select').value;
          
          // å­¦å¹´ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹æˆæ¥­ï¼ˆç©ºæ–‡å­—ã§ãªã„ï¼‰ã ã‘ã‚’taughtClassesé…åˆ—ã«è¿½åŠ 
          if (selectedLevel) {
            taughtClasses.push({
              className: className,//æˆæ¥­æ™‚é™
              level: selectedLevel//æ‹…å½“å­¦å¹´
            });
          }
        });
          
        // GASå´ã®recordTaughtClassesé–¢æ•°ã‚’å‘¼ã³å‡ºã™
      google.script.run
        .withSuccessHandler(function(fortuneResult) {
          // --- å…±é€šã®åˆ†å²è¨­å®š ---
          let bgColor = "#fff";
          let icon = "â“";
          let showAnim = "animate__fadeInDown";

          if (fortuneResult.fortune === "å¤§å‰") {
          bgColor = "#fff8dc";
          icon = "ğŸâœ¨";
          showAnim = "animate__tada";
        } else if (fortuneResult.fortune === "å‰") {
          bgColor = "#e0ffe0";
          icon = "ğŸµğŸŒ¸";
          showAnim = "animate__fadeInUp";
        } else if (fortuneResult.fortune === "å‡¶") {
          bgColor = "#ffe0e0";
          icon = "ğŸ‘ºğŸŒ€";
          showAnim = "animate__shakeX";
        }

        Swal.fire({
          title: `${icon} ${fortuneResult.fortune} ${icon}`,
          html: `
            <div style="text-align:center; font-family: 'Yuji Syuku', serif;">
              <p style="font-size:18px;"><strong>${fortuneResult.message || ''}</strong></p>
              <p>é‹å‹¢ãƒã‚¤ãƒ³ãƒˆ: ${fortuneResult.points || 0}</p>
            </div>
          `,
          confirmButtonText: 'å®Œäº†',
          background: bgColor,
          showClass: { popup: `animate__animated ${showAnim}` },
          hideClass: { popup: 'animate__animated animate__fadeOutUp' }
          }).then(() => {
            currentStatus = "reported";
            updateButtonStates(currentStatus);
            window.top.location.href = appUrl;
          });
        })
        .withFailureHandler(function(error) {
          alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
        })
        .recordTaughtClasses(taughtClasses, selectedPeriod);
      })


      function updateButtonStates(status){
          // statusã«å¿œã˜ã¦ã€æŠ¼ã›ã‚‹ãƒœã‚¿ãƒ³ã ã‘ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
        if (status === 'not-clocked-in') {
          document.getElementById('clock-in-btn').disabled = false;
          document.getElementById("logout-btn").disabled = false;
        } else if (status === 'working') {
          document.getElementById('clock-in-btn').disabled = true;
          document.getElementById('end-break-btn').disabled = true;
          document.getElementById('task-end-btn').disabled = true;
          document.getElementById("update-transportation-fee-btn").disabled = false;
          document.getElementById('clock-out-btn').disabled = false;
          document.getElementById('task-start-btn').disabled = false;
          document.getElementById('start-break-btn').disabled = false;
        } else if (status === 'on-task') {
          document.getElementById('clock-out-btn').disabled = true;
          document.getElementById('task-start-btn').disabled = true;
          document.getElementById('start-break-btn').disabled = true;
          document.getElementById("logout-btn").disabled = true;
          document.getElementById('task-end-btn').disabled = false;
        } else if (status === 'on-break') {
          document.getElementById('clock-out-btn').disabled = true;
          document.getElementById('task-start-btn').disabled = true;
          document.getElementById('start-break-btn').disabled = true;
          document.getElementById("logout-btn").disabled = true;
          document.getElementById('end-break-btn').disabled = false;
        }else if (status === "reported") {
          document.getElementById("logout-btn").disabled = false;

        }
      }


//  ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†

    document.getElementById('logout-btn').addEventListener('click', function() {
    // GASå´ã®`logout`é–¢æ•°ã‚’å‘¼ã³å‡ºã™
      google.script.run
        .withSuccessHandler(function() {
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãŒæˆåŠŸã—ãŸã‚‰ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹
      // doGetãŒå†å®Ÿè¡Œã•ã‚Œã€ä»Šåº¦ã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ç§»å‹•ã™ã‚‹
          window.top.location.href = appUrl;; //ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ãŸã‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼‰ã«å¯¾ã—ã¦ç§»å‹•ã‚’å‘½ã˜ã‚‹
        })
        .logout();
    });
    </script>
  </body>
</html>